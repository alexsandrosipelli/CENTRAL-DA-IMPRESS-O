<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatório Executivo de Uso de Impressoras</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }
    header {
      text-align: center;
      margin-bottom: 40px;
    }
    header h1 {
      color: #007BFF;
    }
    section {
      max-width: 1000px;
      margin: 0 auto 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    input, select, button {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    #resumo {
      background: #e9f7ef;
      padding: 20px;
      margin-top: 30px;
      border-left: 5px solid #28a745;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
  </style>
</head>
<body>

  <header>
    <h1>Relatório Executivo Mensal - Uso de Impressoras</h1>
    <p>Carregue seu arquivo Excel com dados diários para gerar análises mensais.</p>
  </header>

  <section>
    <input type="file" id="excelFile" accept=".xlsx" />
    <br />
    <button onclick="carregarExcel()">Carregar Dados</button>

    <br />
    <label for="mesAno">Selecione mês para análise:</label>
    <select id="mesAno" onchange="exibirRelatorio()"></select>

    <div id="resumo"></div>

    <canvas id="graficoBarras"></canvas>
    <canvas id="graficoLinha"></canvas>
    <canvas id="graficoRadar"></canvas>
    <canvas id="graficoPizza"></canvas>
    <canvas id="graficoDifMedia"></canvas>
  </section>

<script>
  let dadosAgrupadosPorMes = {}; // { '2025-05': { setor1: {...}, setor2: {...} }, ... }
  let mesesDisponiveis = [];

  function carregarExcel() {
    const input = document.getElementById('excelFile');
    if (!input.files.length) {
      alert('Selecione um arquivo Excel (.xlsx)');
      return;
    }
    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });

      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

      if (jsonData.length === 0) {
        alert('Arquivo vazio ou inválido');
        return;
      }

      agruparDados(jsonData);
      preencherSelectMes();
      exibirRelatorio();
    };

    reader.readAsArrayBuffer(file);
  }

  // Função para extrair mês e ano no formato yyyy-mm
  function extrairMesAno(dataStr) {
    // Considera que data vem como "dd/mm/yyyy"
    const partes = dataStr.split('/');
    if (partes.length !== 3) return null;
    return `${partes[2]}-${partes[1].padStart(2, '0')}`;
  }

  function agruparDados(data) {
    dadosAgrupadosPorMes = {};
    mesesDisponiveis = new Set();

    data.forEach(row => {
      const dataRaw = row['data'] || row['Data'] || '';
      const mesAno = extrairMesAno(dataRaw);
      if (!mesAno) return;

      const setor = row['setor'] || row['Setor'] || 'Indefinido';
      const tonerStr = row['TONER'] || row['Toner'] || '0%';
      const qtdPreto = parseInt(row['QTD PRETO'] || row['Qtd Preto'] || 0);
      const qtdCor = parseInt(row['QTD COR'] || row['Qtd Cor'] || 0);
      const diferencaDiaria = parseFloat(row['DIFERENCIA DIARIA'] || row['Diferencia Diaria'] || 0);

      const toner = parseInt(tonerStr.toString().replace('%', '').trim()) || 0;

      if (!dadosAgrupadosPorMes[mesAno]) {
        dadosAgrupadosPorMes[mesAno] = {};
      }
      if (!dadosAgrupadosPorMes[mesAno][setor]) {
        dadosAgrupadosPorMes[mesAno][setor] = {
          totalImpressao: 0,
          registros: 0,
          tonerValues: [],
          registrosTonerBaixo: 0,
          somaDiferencaDiaria: 0
        };
      }

      const setorData = dadosAgrupadosPorMes[mesAno][setor];
      setorData.totalImpressao += qtdPreto + qtdCor;
      setorData.registros++;
      setorData.tonerValues.push(toner);
      setorData.somaDiferencaDiaria += diferencaDiaria;
      if (toner < 20) setorData.registrosTonerBaixo++;

      mesesDisponiveis.add(mesAno);
    });

    mesesDisponiveis = Array.from(mesesDisponiveis).sort();
  }

  function preencherSelectMes() {
    const select = document.getElementById('mesAno');
    select.innerHTML = '';
    mesesDisponiveis.forEach(mes => {
      const opt = document.createElement('option');
      const [ano, mesNum] = mes.split('-');
      opt.value = mes;
      opt.textContent = `${mesNum}/${ano}`;
      select.appendChild(opt);
    });
  }

  let chartBarras, chartLinha, chartRadar, chartPizza, chartDifMedia;

  function exibirRelatorio() {
    const select = document.getElementById('mesAno');
    if (!select.value) return;

    const mesSelecionado = select.value;
    const dadosSetores = dadosAgrupadosPorMes[mesSelecionado];
    if (!dadosSetores) return;

    // KPIs gerais
    const totalImpressaoMes = Object.values(dadosSetores).reduce((acc, cur) => acc + cur.totalImpressao, 0);
    const totalRegistrosMes = Object.values(dadosSetores).reduce((acc, cur) => acc + cur.registros, 0);
    const mediaDiariaMes = (totalImpressaoMes / totalRegistrosMes).toFixed(2);

    // Toner baixo global no mês
    const totalTonerBaixo = Object.values(dadosSetores).reduce((acc, cur) => acc + cur.registrosTonerBaixo, 0);

    // Setores para gráficos
    const setores = Object.keys(dadosSetores);
    const totalImpressaoPorSetor = setores.map(s => dadosSetores[s].totalImpressao);
    const mediaTonerPorSetor = setores.map(s => {
      const vals = dadosSetores[s].tonerValues;
      const soma = vals.reduce((a,b) => a+b, 0);
      return (soma / vals.length).toFixed(2);
    });
    const minTonerPorSetor = setores.map(s => Math.min(...dadosSetores[s].tonerValues));
    const maxTonerPorSetor = setores.map(s => Math.max(...dadosSetores[s].tonerValues));
    const diffMediaPorSetor = setores.map(s => (dadosSetores[s].somaDiferencaDiaria / dadosSetores[s].registros).toFixed(2));
    const percentualTonerBaixoPorSetor = setores.map(s => ((dadosSetores[s].registrosTonerBaixo / dadosSetores[s].registros)*100).toFixed(1));

    // Resumo textual
    const resumoHTML = `
      <h3>Resumo do Mês: ${select.options[select.selectedIndex].text}</h3>
      <ul>
        <li><strong>Total de impressões no mês:</strong> ${totalImpressaoMes}</li>
        <li><strong>Média diária de impressões:</strong> ${mediaDiariaMes}</li>
        <li><strong>Registros com toner baixo (&lt;20%):</strong> ${totalTonerBaixo}</li>
      </ul>
    `;
    document.getElementById('resumo').innerHTML = resumoHTML;

    // Gráfico barras: Total impressão por setor
    if(chartBarras) chartBarras.destroy();
    const ctxBarras = document.getElementById('graficoBarras').getContext('2d');
    chartBarras = new Chart(ctxBarras, {
      type: 'bar',
      data: {
        labels: setores,
        datasets: [{
          label: 'Total de Impressões',
          data: totalImpressaoPorSetor,
          backgroundColor: '#007BFF'
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'Total de Impressões por Setor' }, legend: { display: false } },
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });

    // Gráfico linha: Evolução mensal - aqui só mostramos o mês atual pois não temos histórico acumulado. 
    // Para histórico real, precisaria agregar dados de vários meses e exibir.
    // Por ora mostramos média toner por setor.
    if(chartLinha) chartLinha.destroy();
    const ctxLinha = document.getElementById('graficoLinha').getContext('2d');
    chartLinha = new Chart(ctxLinha, {
      type: 'line',
      data: {
        labels: setores,
        datasets: [{
          label: 'Média TONER (%)',
          data: mediaTonerPorSetor,
          fill: false,
          borderColor: '#28a745',
          tension: 0.1
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'Média de TONER (%) por Setor' }, legend: { display: true } },
        responsive: true,
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });

    // Gráfico radar: Comparação Toner (min, média, max) por setor
    if(chartRadar) chartRadar.destroy();
    const ctxRadar = document.getElementById('graficoRadar').getContext('2d');
    chartRadar = new Chart(ctxRadar, {
      type: 'radar',
      data: {
        labels: setores,
        datasets: [
          {
            label: 'Toner Min (%)',
            data: minTonerPorSetor,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220,53,69,0.2)'
          },
          {
            label: 'Toner Média (%)',
            data: mediaTonerPorSetor,
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255,193,7,0.2)'
          },
          {
            label: 'Toner Máx (%)',
            data: maxTonerPorSetor,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40,167,69,0.2)'
          }
        ]
      },
      options: {
        plugins: { title: { display: true, text: 'Comparação Toner (%) por Setor' } },
        responsive: true,
        scales: {
          r: { min: 0, max: 100 }
        }
      }
    });

    // Gráfico pizza: % registros toner baixo (média)
    if(chartPizza) chartPizza.destroy();
    const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
    chartPizza = new Chart(ctxPizza, {
      type: 'pie',
      data: {
        labels: ['Toner abaixo de 20%', 'Toner acima de 20%'],
        datasets: [{
          data: [
            totalTonerBaixo,
            totalRegistrosMes - totalTonerBaixo
          ],
          backgroundColor: ['#dc3545', '#28a745']
        }]
      },
      options: {
        plugins: { title: { display: true, text: 'Percentual de Registros com Toner Baixo' } },
        responsive: true
      }
    });

    // Gráfico barras horizontais: Diferença diária média por setor
    if(chartDifMedia) chartDifMedia.destroy();
    const ctxDif = document.getElementById('graficoDifMedia').getContext('2d');
    chartDifMedia = new Chart(ctxDif, {
      type: 'bar',
      data: {
        labels: setores,
        datasets: [{
          label: 'Diferença Diária Média',
          data: diffMediaPorSetor,
          backgroundColor: '#17a2b8'
        }]
      },
      options: {
        indexAxis: 'y',
        plugins: { title: { display: true, text: 'Diferença Diária Média por Setor' }, legend: { display: false } },
        responsive: true,
        scales: { x: { beginAtZero: true } }
      }
    });
  }
</script>

</body>
</html>
